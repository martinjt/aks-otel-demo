mode: deployment
nameOverride: cluster-collector
resources:
  limits:
    cpu: 1
    memory: 1Gi
presets:
  kubeletMetrics:
    enabled: true
  kubernetesEvents:
    enabled: true
  kubernetesAttributes:
    enabled: true
image:
  tag: "0.81.0"
config:
  receivers:
    kubeletstats:
      metric_groups:
        - node
        - pod
  exporters:
    otlp/metrics:
      endpoint: api.honeycomb.io:443
      headers:
        x-honeycomb-team: ${HONEYCOMB_API_KEY}
        x-honeycomb-dataset: "kubelet-metrics"
    otlp/logging:
      endpoint: api.honeycomb.io:443
      headers:
        x-honeycomb-team: ${HONEYCOMB_API_KEY}
        x-honeycomb-dataset: "k8s-events"

  processors:
    k8sattributes:
      pod_association:
        - sources:
          - from: resource_attribute
            name: k8s.pod.name
          - from: resource_attribute
            name: k8s.namespace.name
    metricstransform/podnetwork_aggregation:
      transforms:
        - include: k8s.pod.network.io
          match_type: strict
          experimental_match_labels: 
            direction: receive
          action: insert
          new_name: k8s.pod.network.io.receive_bytes
          operations:
            - action: aggregate_labels
              label_set: [k8s.namespace, k8s.pod.name, k8s.pod.uid]
              aggregation_type: sum
        - include: k8s.pod.network.io
          match_type: strict
          experimental_match_labels: 
            direction: transmit
          action: insert
          new_name: k8s.pod.network.io.transmit_bytes
          operations:
            - action: aggregate_labels
              label_set: [k8s.namespace, k8s.pod.name, k8s.pod.uid]
              aggregation_type: sum
        - include: k8s.pod.network.io
          action: update
          operations:
            - action: delete_label_value
              label: direction
              label_value: receive
            - action: delete_label_value
              label: direction
              label_value: transmit
        - include: k8s.pod.network.errors
          action: update
          operations:
            - action: delete_label_value
              label: direction
              label_value: receive
            - action: delete_label_value
              label: direction
              label_value: transmit
  service:
    pipelines:
      metrics:
        processors: [metricstransform/podnetwork_aggregation]
        exporters: [otlp/metrics]
      logs:
        exporters: [otlp/logging]
    telemetry:
      logs:
        level: "debug"
